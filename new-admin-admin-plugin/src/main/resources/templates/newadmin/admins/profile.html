<!--
 ~ Copyright 2022 youngmonkeys.org
 ~ 
 ~ Licensed under the ezyplatform, Version 1.0.0 (the "License");
 ~ you may not use this file except in compliance with the License.
 ~ You may obtain a copy of the License at
 ~ 
 ~     https://youngmonkeys.org/licenses/ezyplatform-1.0.0.txt
 ~ 
 ~ Unless required by applicable law or agreed to in writing, software
 ~ distributed under the License is distributed on an "AS IS" BASIS,
 ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 ~ See the License for the specific language governing permissions and
 ~ limitations under the License.
-->

<!DOCTYPE html>
<html
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{newadmin}"
>
  <body>
    <div layout:fragment="content" class="row">
      <div class="col-12 px-0">
        <div th:replace="~{newadmin/admins/profile/avatar :: avatar}"></div>
      </div>
      <div class="col-12 col-md-5">
        <div th:replace="~{newadmin/admins/profile/info :: infomation}"></div>
      </div>
      <div class="col">
        <div th:replace="~{newadmin/admins/profile/activity :: activity}"></div>
      </div>
    </div>
    <th:block layout:fragment="modals">
      <th:block th:replace="~{modals/change-password :: content}" />
    </th:block>
    <script layout:fragment="scripts" th:inline="javascript">
      /*<![CDATA[*/
      ezyadmin.adminIsMe = /*[[${selectedAdmin.id == adminId}]]*/;
      ezyadmin.selectedAdminId = /*[[${selectedAdmin.id}]]*/ '';
      ezyadmin.selectedAdminUsername = /*[[${selectedAdmin.username}]]*/ '';
      ezyadmin.accessibleUris['/api/v1/admins/{adminId}/activities'] = /*[[${adminRoles.isAccessible('/api/v1/admins/{adminId}/activities')}]]*/;
      /*]]>*/

      // ========== admin init =============
      ezyadmin.onEditButtonClick = function() {
          var url = ezyadmin.adminIsMe
              ? '/admins/me/edit'
              : '/admins/' + ezyadmin.selectedAdminUsername + '/edit';
          window.location = url + (ezyadmin.lang ? '?lang=' + ezyadmin.lang : '');
      }

      ezyadmin.changePasswordApi = {
          url: ezyadmin.adminIsMe
              ? '/api/v1/admins/me/update-password'
              : '/api/v1/admins/' + ezyadmin.selectedAdminUsername + '/update-password'
      };

      ezyadmin.createDataTable('roleList', 12);

      // ========== admin update ==========================
      ezyadmin.onAllowAccessAllMediaChanged = function(e) {
          var allow = $(e).prop('checked');
          $.ajax({
              type: 'PUT',
              url: '/api/v1/admins/' + ezyadmin.selectedAdminUsername + '/allow-access-all-media',
              contentType: 'application/json',
              data: JSON.stringify({allow: allow}),
              success: function () {
                  // do nothing
              },
              error: function (data, e) {
                  ezyadmin.processUpdateApiErrors({}, data);
              }
          });
      }

      // ========== admin activity =============
      ezyadmin.onKeydownToSearchAdminActivity = function() {
          ezyadmin.adminActivitySearchKeyword = $('#adminActivitySearchKeyword').val();
          if(event.key === 'Enter' || !ezyadmin.adminActivitySearchKeyword) {
              ezyadmin.fetchAdminActivityList();
          }
      }

      ezyadmin.onAdminActivitySearchHttpMethodChanged = function() {
          ezyadmin.adminActivitySearchHttpMethod = $('#adminActivitySearchHttpMethod').val();
          ezyadmin.fetchAdminActivityList();
      }

      $(document).ready(() => {
          ezyadmin.createDateRangePicker(
              '#adminActivitySearchTimeRangePicker',
              {},
              function(start, end, label) {
                  ezyadmin.adminActivitySearchCreatedAtStartInclusive = start.unix() * 1000;
                  ezyadmin.adminActivitySearchCreatedAtEndInclusive = end.unix() * 1000;
                  ezyadmin.fetchAdminActivityList();
              }
          );
          $('#adminActivitySearchTimeRangePicker').on('cancel.daterangepicker', function (ev, picker) {
              ezyadmin.adminActivitySearchCreatedAtStartInclusive = 0;
              ezyadmin.adminActivitySearchCreatedAtEndInclusive = 0;
              ezyadmin.fetchAdminActivityList();
          });
      });

      // ========== admin activity pagination =============
      $('#firstPageButton').click(() => {
          ezyadmin.fetchAdminActivityList('first');
      });
      $('#lastPageButton').click(() => {
          ezyadmin.fetchAdminActivityList('last');
      });
      $('#nextPageButton').click(() => {
          ezyadmin.fetchAdminActivityList('next');
      });
      $('#prevPageButton').click(() => {
          ezyadmin.fetchAdminActivityList('prev');
      });

      // ========== admin activity list =============
      ezyadmin.fetchAdminActivityList = function(action) {
          var queryString = '';
          if (ezyadmin.adminActivitySearchKeyword) {
              queryString += '&keyword=' + ezyadmin.adminActivitySearchKeyword;
          }
          if (ezyadmin.adminActivitySearchHttpMethod) {
              queryString += '&method=' + ezyadmin.adminActivitySearchHttpMethod;
          }
          if (ezyadmin.adminActivitySearchCreatedAtStartInclusive) {
              queryString += '&createdAtStartInclusive=' + ezyadmin.adminActivitySearchCreatedAtStartInclusive;
          }
          if (ezyadmin.adminActivitySearchCreatedAtEndInclusive) {
              queryString += '&createdAtEndInclusive=' + ezyadmin.adminActivitySearchCreatedAtEndInclusive;
          }
          if (action == 'next') {
              if (ezyadmin.lastAdminActivityPageToken.next) {
                  queryString += '&nextPageToken=' + ezyadmin.lastAdminActivityPageToken.next;
              } else {
                  return;
              }
          } else if (action == 'prev') {
              if (ezyadmin.lastAdminActivityPageToken.prev) {
                  queryString += '&prevPageToken=' + ezyadmin.lastAdminActivityPageToken.prev;
              } else {
                  return;
              }
          } else if (action == 'last') {
              queryString += '&lastPage=true';
          }
          var requestUri = ezyadmin.adminIsMe
              ? '/api/v1/admins/me/activities'
              : '/api/v1/admins/' + ezyadmin.selectedAdminId + '/activities';
          $.ajax({
              url: requestUri + '?limit=12' + queryString,
              type: 'GET',
              dataType: 'json'
          })
          .done(function(data) {
              $('#adminActivityCountText').text(data.count);
              $('#totalAdminActivityText').text(data.total);
              ezyadmin.lastAdminActivityPageToken = data.pageToken;
              $('#adminActivityListBody').html(ezyadmin.buildAdminActivityListBodyHtml(data.items));
              if (data.continuation.hasNext) {
                  $('#nextPageButton').removeClass('text-secondary');
              } else {
                  $('#nextPageButton').addClass('text-secondary');
              }
              if (data.continuation.hasPrevious) {
                  $('#prevPageButton').removeClass('text-secondary');
              } else {
                  $('#prevPageButton').addClass('text-secondary');
              }
          })
          .fail(function(e) {
              ezyadmin.processGetApiErrors(e);
          });
      }

      ezyadmin.buildAdminActivityListBodyHtml = function(adminActivities) {
          var html = '';
          adminActivities.forEach((adminActivity) => {
              html += ezyadmin.buildAdminActivityListItemHtml(adminActivity);
          });
          return html;
      }
      ezyadmin.buildAdminActivityListItemHtml = function(adminActivity) {
          var statusColor = ezyadmin.getTextColorByStatus(adminActivity.status);
          var html = `
              <tr>
                  <td>${ezyadmin.formatTimeStamp(adminActivity.createdAt)}</td>
                  <td>${adminActivity.method}</td>
                  <td>${adminActivity.uri}</td>
                  <td>${adminActivity.uriType}</td>
                  <td>${adminActivity.feature || ''}</td>
                  <td class="text-wrap line-break-anywhere">${adminActivity.parameters || ''}</td>
              </tr>
              `;
          return html;
      }
      ezyadmin.fetchAdminActivityList();
    </script>
    <th:block layout:fragment="post-scripts">
      <script th:replace="~{admins/scripts :: avatar}" />
      <script th:replace="~{modals/change-password :: scripts}" />
      <script th:replace="~{fragments/date-range-picker :: scripts}" />
    </th:block>
  </body>
</html>
